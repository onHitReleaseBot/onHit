name: Sync Readme to Xposed-Modules-Repo

env:
    TARGET_REPO: "Xposed-Modules-Repo/mba.vm.onhit"

permissions:
  contents: read

on:
  push:
    branches: [ "main" ]
    paths:
      - 'README.md'

jobs:
    sync:
        if: github.repository == '0penPublic/onHit'
        environment: main_build
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                fetch-depth: 0
                repository: ${{ env.TARGET_REPO }}
                token: ${{ secrets.XPOSED_MODULES_REPO_PUBLISH_TOKEN }}

            - name: Fetch Raw README
              run: |
                curl -fsSL https://raw.githubusercontent.com/0penPublic/onHit/${{ github.sha }}/README.md -o README.md
            
            - name: Push to Repo
              run: |
                git config user.name "onHitReleaseBot"
                git config user.email "onhit_release_bot@vm.mba"
                git add README.md

                if git diff --staged --quiet; then
                    echo "No changes to sync."
                else
                    SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
                    git commit -m "docs: Update README.md from source" \
                        -m "Source commit: https://github.com/0penPublic/onHit/commit/${{ github.sha }} ($SHORT_SHA)" \
                        -m "Co-authored-by: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>"
                    git push origin main
                fi